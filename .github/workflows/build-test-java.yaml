name: Build and Test Java Project

on:
  workflow_call:
    inputs:
      java-version:
        description: "Java version to use"
        default: "17"
        type: string
      working-directory:
        description: "The directory to run jobs from"
        default: "."
        type: string
      runner:
        description: "Runner type (ubuntu-latest or self-hosted)"
        default: "ubuntu-latest"
        type: string
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  build_and_test:
    runs-on: ${{ inputs.runner != '' && inputs.runner || 'ubuntu-latest' }}
    permissions:
      contents: read
      checks: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version != '' && inputs.java-version || '17' }}
          distribution: "temurin"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Download pre-populated Gradle dependencies cache
        id: gradle-cache
        run: |
          mkdir -p ~/.gradle/caches
          BASE_URL="https://github.com/${{ github.repository }}/releases/download/deps-cache"

          # Download checksums file to get list of available dependencies
          if curl -fL -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -o /tmp/gradle-deps-checksums.sha256 "${BASE_URL}/gradle-deps-checksums.sha256" 2>/dev/null; then
            echo "âœ… Downloading dependency archives..."

            # Extract archive names from checksums file
            DEPENDENCY_COUNT=0
            while IFS= read -r line; do
              ARCHIVE_NAME=$(echo "$line" | awk '{print $2}')
              if [ -n "$ARCHIVE_NAME" ]; then
                ARCHIVE_URL="${BASE_URL}/${ARCHIVE_NAME}"
                echo "Downloading: $ARCHIVE_NAME"
                if curl -fL -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -o "/tmp/${ARCHIVE_NAME}" "$ARCHIVE_URL" 2>/dev/null; then
                  DEPENDENCY_COUNT=$((DEPENDENCY_COUNT + 1))
                else
                  echo "âš ï¸  Failed to download: $ARCHIVE_NAME"
                fi
              fi
            done < /tmp/gradle-deps-checksums.sha256

            echo "Downloaded $DEPENDENCY_COUNT dependency archives"

            # Verify checksums
            cd /tmp && sha256sum -c gradle-deps-checksums.sha256 && cd -

            # Extract each dependency archive (contains both files-2.1 and metadata-2.*)
            for ARCHIVE in /tmp/gradle-deps-*.tar.gz; do
              if [ -f "$ARCHIVE" ]; then
                echo "Extracting: $(basename $ARCHIVE)"
                tar -xzf "$ARCHIVE" -C ~/.gradle/caches
              fi
            done

            echo "âœ… Dependencies cache restored (JARs + metadata)"
            echo "cache_available=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸  No pre-populated cache found, Gradle will download dependencies"
            echo "cache_available=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Build
        working-directory: ${{ inputs.working-directory != '' && inputs.working-directory || '.' }}
        run: |
          if [ "${{ steps.gradle-cache.outputs.cache_available }}" == "true" ]; then
            echo "ğŸ”’ Building in offline mode (using cached dependencies)"
            ./gradlew build -x test --offline
          else
            echo "ğŸŒ Building with network access"
            ./gradlew build -x test
          fi

      - name: Run tests
        working-directory: ${{ inputs.working-directory != '' && inputs.working-directory || '.' }}
        run: |
          if [ "${{ steps.gradle-cache.outputs.cache_available }}" == "true" ]; then
            echo "ğŸ”’ Running tests in offline mode (using cached dependencies)"
            ./gradlew test --offline
          else
            echo "ğŸŒ Running tests with network access"
            ./gradlew test
          fi

      - name: Generate coverage report
        working-directory: ${{ inputs.working-directory != '' && inputs.working-directory || '.' }}
        run: |
          if [ "${{ steps.gradle-cache.outputs.cache_available }}" == "true" ]; then
            echo "ğŸ”’ Generating coverage report in offline mode"
            ./gradlew jacocoTestReport --offline
          else
            echo "ğŸŒ Generating coverage report with network access"
            ./gradlew jacocoTestReport
          fi

      - name: Publish Test Results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Test Results
          path: "**/build/test-results/test/*.xml,**/build/test-results/**/*.xml"
          reporter: "java-junit"
          fail-on-error: false
          list-suites: "all"
          list-tests: "all"

      - name: Upload Test Coverage Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: "**/build/reports/jacoco/**"
          retention-days: 2
