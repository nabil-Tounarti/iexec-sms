name: Build and Test Java Project

on:
  workflow_call:
    inputs:
      java-version:
        description: "Java version to use"
        default: "17"
        type: string
      working-directory:
        description: "The directory to run jobs from"
        default: "."
        type: string
      runner:
        description: "Runner type (ubuntu-latest or self-hosted)"
        default: "ubuntu-latest"
        type: string
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  build_and_test:
    runs-on: ${{ inputs.runner != '' && inputs.runner || 'ubuntu-latest' }}
    permissions:
      contents: read
      checks: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version != '' && inputs.java-version || '17' }}
          distribution: "temurin"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Download pre-populated Nexus dependencies cache
        id: nexus-cache
        run: |
          mkdir -p ~/.gradle/caches/modules-2/files-2.1
          BASE_URL="https://github.com/${{ github.repository }}/releases/download/deps-cache"

          # Download checksums file to get list of available dependencies
          if curl -fL -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -o /tmp/gradle-deps-checksums.sha256 "${BASE_URL}/gradle-deps-checksums.sha256" 2>/dev/null; then
            echo "‚úÖ Downloading Nexus dependency archives..."

            # Extract archive names from checksums file
            DEPENDENCY_COUNT=0
            while IFS= read -r line; do
              ARCHIVE_NAME=$(echo "$line" | awk '{print $2}')
              if [ -n "$ARCHIVE_NAME" ]; then
                ARCHIVE_URL="${BASE_URL}/${ARCHIVE_NAME}"
                echo "Downloading: $ARCHIVE_NAME"
                if curl -fL -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -o "/tmp/${ARCHIVE_NAME}" "$ARCHIVE_URL" 2>/dev/null; then
                  DEPENDENCY_COUNT=$((DEPENDENCY_COUNT + 1))
                else
                  echo "‚ö†Ô∏è  Failed to download: $ARCHIVE_NAME"
                fi
              fi
            done < /tmp/gradle-deps-checksums.sha256

            echo "Downloaded $DEPENDENCY_COUNT dependency archives"

            # Verify checksums
            cd /tmp && sha256sum -c gradle-deps-checksums.sha256 && cd -

            # Extract each dependency archive (contains modules-2 structure with files-2.1 and metadata)
            for ARCHIVE in /tmp/gradle-deps-*.tar.gz; do
              if [ -f "$ARCHIVE" ]; then
                echo "Extracting: $(basename $ARCHIVE)"
                # Debug: show archive contents
                echo "Archive contents:"
                tar -tzf "$ARCHIVE" | head -10
                # Archives contain modules-2 structure, extract to caches root
                tar -xzf "$ARCHIVE" -C ~/.gradle/caches
                echo "Extracted to: ~/.gradle/caches"
              fi
            done

            # Verify cache structure
            echo "Verifying cache structure..."
            echo "Checking: ~/.gradle/caches/modules-2/files-2.1/"
            ls -la ~/.gradle/caches/modules-2/files-2.1/ 2>/dev/null | head -20 || echo "Directory doesn't exist"
            if [ -d ~/.gradle/caches/modules-2/files-2.1/com.iexec.commons/iexec-commons-poco ]; then
              echo "‚úÖ Found iexec-commons-poco in cache"
              ls -la ~/.gradle/caches/modules-2/files-2.1/com.iexec.commons/iexec-commons-poco/
            else
              echo "‚ö†Ô∏è  iexec-commons-poco not found in cache"
              echo "Looking for any com.iexec.* directories:"
              find ~/.gradle/caches/modules-2/files-2.1 -type d -name "com.iexec.*" 2>/dev/null | head -10 || echo "None found"
            fi
            if [ -d ~/.gradle/caches/modules-2/files-2.1/com.iexec.common/iexec-common ]; then
              echo "‚úÖ Found iexec-common in cache"
              ls -la ~/.gradle/caches/modules-2/files-2.1/com.iexec.common/iexec-common/
            else
              echo "‚ö†Ô∏è  iexec-common not found in cache"
            fi

            echo "‚úÖ Nexus dependencies cache restored"
            echo "nexus_cache_available=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  No pre-populated cache found - build will fail without VPN access"
            echo "nexus_cache_available=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Download Gradle plugins and public dependencies (online)
        working-directory: ${{ inputs.working-directory != '' && inputs.working-directory || '.' }}
        run: |
          if [ "${{ steps.nexus-cache.outputs.nexus_cache_available }}" == "true" ]; then
            echo "üì• Downloading Gradle plugins and public dependencies (requires online access)..."
            echo "üîß Creating Gradle init script to disable Nexus repository..."
            # Create init script that removes Nexus repository
            mkdir -p ~/.gradle/init.d
            echo 'allprojects { repositories.removeAll { it.name == "Nexus" } }' > ~/.gradle/init.d/disable-nexus.gradle
            echo "Resolving dependencies (Nexus deps from cache, public deps from Maven Central)..."
            # Now Gradle will use cached Nexus deps and download public deps
            ./gradlew dependencies --configuration compileClasspath 2>&1 | tail -30 || true
            # Cleanup init script
            rm -f ~/.gradle/init.d/disable-nexus.gradle
            echo "‚úÖ Dependencies resolved (Nexus from cache, public from Maven Central)"
          else
            echo "üì• Downloading Gradle plugins and public dependencies..."
            ./gradlew dependencies --configuration compileClasspath 2>&1 | tail -30 || true
            echo "‚úÖ Public dependencies cached"
          fi

      - name: Build
        working-directory: ${{ inputs.working-directory != '' && inputs.working-directory || '.' }}
        run: |
          if [ "${{ steps.nexus-cache.outputs.nexus_cache_available }}" == "true" ]; then
            echo "‚úÖ Using cached Nexus dependencies (offline mode)"
            # Build with --offline to use cache only (plugins already downloaded)
            ./gradlew build -x test --offline
          else
            echo "‚ö†Ô∏è  No cache available - build will fail (upload cache archive to release)"
            ./gradlew build -x test
          fi

      - name: Run tests
        working-directory: ${{ inputs.working-directory != '' && inputs.working-directory || '.' }}
        run: |
          if [ "${{ steps.nexus-cache.outputs.nexus_cache_available }}" == "true" ]; then
            ./gradlew test --offline
          else
            ./gradlew test
          fi

      - name: Generate coverage report
        working-directory: ${{ inputs.working-directory != '' && inputs.working-directory || '.' }}
        run: |
          if [ "${{ steps.nexus-cache.outputs.nexus_cache_available }}" == "true" ]; then
            ./gradlew jacocoTestReport --offline
          else
            ./gradlew jacocoTestReport
          fi

      - name: Publish Test Results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Test Results
          path: "**/build/test-results/test/*.xml,**/build/test-results/**/*.xml"
          reporter: "java-junit"
          fail-on-error: false
          list-suites: "all"
          list-tests: "all"

      - name: Upload Test Coverage Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: "**/build/reports/jacoco/**"
          retention-days: 2
