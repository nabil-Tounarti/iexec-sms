name: Build and Test Java Project

on:
  workflow_call:
    inputs:
      java-version:
        description: "Java version to use"
        default: "17"
        type: string
      working-directory:
        description: "The directory to run jobs from"
        default: "."
        type: string
      runner:
        description: "Runner type (ubuntu-latest or self-hosted)"
        default: "ubuntu-latest"
        type: string
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  build_and_test:
    runs-on: ${{ inputs.runner != '' && inputs.runner || 'ubuntu-latest' }}
    permissions:
      contents: read
      checks: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version != '' && inputs.java-version || '17' }}
          distribution: "temurin"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Download pre-populated Nexus dependencies cache
        id: nexus-cache
        run: |
          mkdir -p ~/.gradle/caches/modules-2/files-2.1
          BASE_URL="https://github.com/${{ github.repository }}/releases/download/deps-cache"

          # Download checksums file to get list of available dependencies
          if curl -fL -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -o /tmp/gradle-deps-checksums.sha256 "${BASE_URL}/gradle-deps-checksums.sha256" 2>/dev/null; then
            echo "‚úÖ Downloading Nexus dependency archives..."

            # Extract archive names from checksums file
            DEPENDENCY_COUNT=0
            while IFS= read -r line; do
              ARCHIVE_NAME=$(echo "$line" | awk '{print $2}')
              if [ -n "$ARCHIVE_NAME" ]; then
                ARCHIVE_URL="${BASE_URL}/${ARCHIVE_NAME}"
                echo "Downloading: $ARCHIVE_NAME"
                if curl -fL -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -o "/tmp/${ARCHIVE_NAME}" "$ARCHIVE_URL" 2>/dev/null; then
                  DEPENDENCY_COUNT=$((DEPENDENCY_COUNT + 1))
                else
                  echo "‚ö†Ô∏è  Failed to download: $ARCHIVE_NAME"
                fi
              fi
            done < /tmp/gradle-deps-checksums.sha256

            echo "Downloaded $DEPENDENCY_COUNT dependency archives"

            # Verify checksums
            cd /tmp && sha256sum -c gradle-deps-checksums.sha256 && cd -

            # Extract each dependency archive (contains modules-2 structure with files-2.1 and metadata)
            for ARCHIVE in /tmp/gradle-deps-*.tar.gz; do
              if [ -f "$ARCHIVE" ]; then
                echo "Extracting: $(basename $ARCHIVE)"
                # Archives contain modules-2 structure, extract to caches root
                tar -xzf "$ARCHIVE" -C ~/.gradle/caches
                echo "Extracted to: ~/.gradle/caches"
              fi
            done

            # Force Gradle to rebuild cache index by touching cache lock files
            # This ensures Gradle recognizes the manually extracted files
            echo "Rebuilding Gradle cache index..."
            find ~/.gradle/caches/modules-2 -name "*.lock" -delete 2>/dev/null || true

            # Verify cache structure
            echo "Verifying cache structure..."
            echo "Checking: ~/.gradle/caches/modules-2/files-2.1/"
            ls -la ~/.gradle/caches/modules-2/files-2.1/ 2>/dev/null | head -20 || echo "Directory doesn't exist"
            # Check for correct structure (with group directory)
            if [ -d ~/.gradle/caches/modules-2/files-2.1/com.iexec.commons/iexec-commons-poco ]; then
              echo "‚úÖ Found iexec-commons-poco in cache (correct structure)"
              ls -la ~/.gradle/caches/modules-2/files-2.1/com.iexec.commons/iexec-commons-poco/
            elif [ -d ~/.gradle/caches/modules-2/files-2.1/iexec-commons-poco ]; then
              echo "‚ö†Ô∏è  Found iexec-commons-poco but missing group directory - fixing..."
              # Fix structure: move to correct location
              mkdir -p ~/.gradle/caches/modules-2/files-2.1/com.iexec.commons
              mv ~/.gradle/caches/modules-2/files-2.1/iexec-commons-poco ~/.gradle/caches/modules-2/files-2.1/com.iexec.commons/
              echo "‚úÖ Fixed structure"
            else
              echo "‚ö†Ô∏è  iexec-commons-poco not found in cache"
              find ~/.gradle/caches/modules-2/files-2.1 -type d -name "*iexec*" 2>/dev/null | head -10 || echo "None found"
            fi
            if [ -d ~/.gradle/caches/modules-2/files-2.1/com.iexec.common/iexec-common ]; then
              echo "‚úÖ Found iexec-common in cache (correct structure)"
              ls -la ~/.gradle/caches/modules-2/files-2.1/com.iexec.common/iexec-common/
            elif [ -d ~/.gradle/caches/modules-2/files-2.1/iexec-common ]; then
              echo "‚ö†Ô∏è  Found iexec-common but missing group directory - fixing..."
              mkdir -p ~/.gradle/caches/modules-2/files-2.1/com.iexec.common
              mv ~/.gradle/caches/modules-2/files-2.1/iexec-common ~/.gradle/caches/modules-2/files-2.1/com.iexec.common/
              echo "‚úÖ Fixed structure"
            else
              echo "‚ö†Ô∏è  iexec-common not found in cache"
            fi

            echo "‚úÖ Nexus dependencies cache restored"
            echo "nexus_cache_available=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  No pre-populated cache found - build will fail without VPN access"
            echo "nexus_cache_available=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Download Gradle plugins and public dependencies (online)
        working-directory: ${{ inputs.working-directory != '' && inputs.working-directory || '.' }}
        run: |
          if [ "${{ steps.nexus-cache.outputs.nexus_cache_available }}" == "true" ]; then
            echo "üì• Downloading Gradle plugins and public dependencies (requires online access)..."
            echo "üîß Copying cached dependencies to mavenLocal for Gradle to find them..."
            # Copy cached dependencies to mavenLocal (~/.m2/repository)
            # Gradle checks mavenLocal before remote repositories
            # mavenLocal structure: ~/.m2/repository/com/iexec/commons/iexec-commons-poco/5.3.1/iexec-commons-poco-5.3.1.jar

            # Copy iexec-commons-poco
            for VERSION_DIR in ~/.gradle/caches/modules-2/files-2.1/com.iexec.commons/iexec-commons-poco/*/; do
              if [ -d "$VERSION_DIR" ]; then
                VERSION=$(basename "$VERSION_DIR")
                mkdir -p ~/.m2/repository/com/iexec/commons/iexec-commons-poco/$VERSION
                # Find JAR file (not sources/javadoc) and copy with correct name
                JAR_FILE=$(find "$VERSION_DIR" -name "*.jar" ! -name "*-sources.jar" ! -name "*-javadoc.jar" | head -1)
                if [ -n "$JAR_FILE" ] && [ -f "$JAR_FILE" ]; then
                  cp "$JAR_FILE" ~/.m2/repository/com/iexec/commons/iexec-commons-poco/$VERSION/iexec-commons-poco-$VERSION.jar
                fi
                # Find POM file and copy
                POM_FILE=$(find "$VERSION_DIR" -name "*.pom" | head -1)
                if [ -n "$POM_FILE" ] && [ -f "$POM_FILE" ]; then
                  cp "$POM_FILE" ~/.m2/repository/com/iexec/commons/iexec-commons-poco/$VERSION/iexec-commons-poco-$VERSION.pom
                fi
              fi
            done

            # Copy iexec-common
            for VERSION_DIR in ~/.gradle/caches/modules-2/files-2.1/com.iexec.common/iexec-common/*/; do
              if [ -d "$VERSION_DIR" ]; then
                VERSION=$(basename "$VERSION_DIR")
                mkdir -p ~/.m2/repository/com/iexec/common/iexec-common/$VERSION
                # Find JAR file and copy with correct name
                JAR_FILE=$(find "$VERSION_DIR" -name "*.jar" ! -name "*-sources.jar" ! -name "*-javadoc.jar" | head -1)
                if [ -n "$JAR_FILE" ] && [ -f "$JAR_FILE" ]; then
                  cp "$JAR_FILE" ~/.m2/repository/com/iexec/common/iexec-common/$VERSION/iexec-common-$VERSION.jar
                fi
                # Find POM file and copy
                POM_FILE=$(find "$VERSION_DIR" -name "*.pom" | head -1)
                if [ -n "$POM_FILE" ] && [ -f "$POM_FILE" ]; then
                  cp "$POM_FILE" ~/.m2/repository/com/iexec/common/iexec-common/$VERSION/iexec-common-$VERSION.pom
                fi
              fi
            done

            echo "‚úÖ Copied dependencies to mavenLocal"
            echo "Verifying mavenLocal structure:"
            ls -la ~/.m2/repository/com/iexec/commons/iexec-commons-poco/*/ 2>/dev/null | head -10 || echo "No files found"
            ls -la ~/.m2/repository/com/iexec/common/iexec-common/*/ 2>/dev/null | head -10 || echo "No files found"

            echo "üîß Temporarily disabling Nexus repository..."
            # Backup build.gradle
            cp build.gradle build.gradle.bak
            # Comment out Nexus repository block (lines 33-45)
            sed -i '33,45s/^/\/\/ /' build.gradle
            # Fix double commenting
            sed -i 's|^// // |// |g' build.gradle

            echo "Resolving dependencies (Nexus deps from mavenLocal cache, public deps from Maven Central)..."
            # Gradle will check mavenLocal first (where we copied the deps), then Maven Central
            echo "Resolving dependencies..."
            ./gradlew dependencies --configuration compileClasspath 2>&1 | grep -E "(com.iexec|FAILED|Resolved|BUILD|Downloaded)" | head -30 || true

            echo "Downloading Lombok and other public dependencies..."
            ./gradlew generateEffectiveLombokConfig 2>&1 | tail -30 || true

            echo "Downloading compile-time dependencies..."
            ./gradlew compileJava 2>&1 | tail -30 || true

            echo "Dependencies download completed"
            # Restore build.gradle
            mv build.gradle.bak build.gradle
            echo "‚úÖ Dependencies resolved (Nexus from cache, public from Maven Central)"
          else
            echo "üì• Downloading Gradle plugins and public dependencies..."
            ./gradlew dependencies --configuration compileClasspath 2>&1 | tail -30 || true
            echo "‚úÖ Public dependencies cached"
          fi

      - name: Build
        working-directory: ${{ inputs.working-directory != '' && inputs.working-directory || '.' }}
        run: |
          if [ "${{ steps.nexus-cache.outputs.nexus_cache_available }}" == "true" ]; then
            echo "‚úÖ Using cached Nexus dependencies (offline mode)"
            # Build with --offline to use cache only (plugins already downloaded)
            ./gradlew build -x test --offline
          else
            echo "‚ö†Ô∏è  No cache available - build will fail (upload cache archive to release)"
            ./gradlew build -x test
          fi

      - name: Run tests
        working-directory: ${{ inputs.working-directory != '' && inputs.working-directory || '.' }}
        run: |
          if [ "${{ steps.nexus-cache.outputs.nexus_cache_available }}" == "true" ]; then
            ./gradlew test --offline
          else
            ./gradlew test
          fi

      - name: Generate coverage report
        working-directory: ${{ inputs.working-directory != '' && inputs.working-directory || '.' }}
        run: |
          if [ "${{ steps.nexus-cache.outputs.nexus_cache_available }}" == "true" ]; then
            ./gradlew jacocoTestReport --offline
          else
            ./gradlew jacocoTestReport
          fi

      - name: Publish Test Results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Test Results
          path: "**/build/test-results/test/*.xml,**/build/test-results/**/*.xml"
          reporter: "java-junit"
          fail-on-error: false
          list-suites: "all"
          list-tests: "all"

      - name: Upload Test Coverage Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: "**/build/reports/jacoco/**"
          retention-days: 2
